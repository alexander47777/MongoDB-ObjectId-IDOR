# MongoDB ObjectId IDOR Exploit - PentesterLab Challenge Solution

## Overview

This repository contains a Python script that solves a specific [PentesterLab](https://pentesterlab.com/exercises/mongo-idor-iii) challenge demonstrating an Insecure Direct Object Reference (IDOR) vulnerability. The challenge involves exploiting the structure of MongoDB's `ObjectId` to enumerate and access an administrator's account, ultimately retrieving a hidden key.

## The Challenge

The challenge required finding an IDOR vulnerability where user accounts were identified by MongoDB `ObjectId` values. The key insight provided was that:

* ObjectIds contain a 4-byte Unix timestamp, a 5-byte process-specific random value, and a 3-byte incrementing counter.
* The administrator account (`admin@libcurl.so`) was created "a few seconds before" other accounts, and all accounts were created within the same process.

This meant the 5-byte random value would be constant across all relevant ObjectIds, and only the timestamp and the 3-byte counter would need to be guessed/adjusted.

## The Vulnerability (IDOR on MongoDB ObjectId)

The application exposed an API endpoint (`/api/v1/accounts/<ObjectId>`) that allowed fetching details of any user by their `ObjectId`. By crafting specific `ObjectId` values, it was possible to bypass authorization and access sensitive information from other users, specifically the administrator's account which held the challenge's secret key (`PTLAB_KEY`).

The exploitation relied on the predictable nature of MongoDB ObjectIds under specific conditions:

1.  **Shared Process:** When all target ObjectIds are generated by the same process, their 5-byte random component remains constant.
2.  **Sequential Creation:** If accounts are created sequentially, even across small time differences, their timestamps will be close, and their counters will increment predictably.

**The following screenshot shows the initial response listing user ObjectIds:**

![image](https://github.com/user-attachments/assets/23ca3b72-f559-4b7d-ac44-dde33c27cdfd)

![image](https://github.com/user-attachments/assets/a03d3f94-cd82-4f44-82c5-b7a0fefe4f0c)



## Solution Script: `mongo.py`

The provided Python script (`mongo.py`) automates the exploitation process:

1.  **Deconstructs a Reference ObjectId:** It takes an `ObjectId` from a known user (e.g., your own account or one obtained from an enumeration endpoint) and extracts its timestamp, constant random bytes, and counter.
2.  **Generates Guesses:** It then iteratively decrements the timestamp (to search for accounts created "a few seconds before") and the counter (to account for sequential creation within the same second or prior seconds).
3.  **Crafts Malicious ObjectIds:** For each combination of adjusted timestamp and counter, it reconstructs a full `ObjectId` using the constant random bytes.
4.  **Makes API Requests:** It sends `GET` requests to the vulnerable `/api/v1/accounts/<guessed_ObjectId>` endpoint.
5.  **Analyzes Responses:** It parses the JSON response, looking for the `PTLAB_KEY` field with a non-null value, indicating successful compromise of the administrator's account.

### How it Works (Technical Details)

The script leverages Python's `struct` and `binascii` modules to correctly pack and unpack the binary components of the ObjectId (Unix timestamp, counter) into their hexadecimal string representations, ensuring they match MongoDB's `ObjectId` format.

* **Timestamp:** The first 4 bytes are a Unix timestamp. The script decrements this value second by second.
* **Random Bytes:** The next 5 bytes are a process-specific random value. This value is extracted from the base ObjectId and kept constant for all generated guesses.
* **Counter:** The last 3 bytes are an incrementing counter. As observed, this part increments predictably. The script decrements this counter by small amounts to find the admin's slightly earlier account.


**The following screenshot shows the successful response with the `PTLAB_KEY`:**

![image](https://github.com/user-attachments/assets/2ea0312f-8b3b-4309-be0c-43ed6ab3b1bb)


